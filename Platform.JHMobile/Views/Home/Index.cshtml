@{
    ViewBag.Title = "认证";
}

@{ 
    if (Session["user_id"] != null)
    {
        Response.Redirect("~/Home/Home");
        return;
    }
    var url_get_access_token = string.Format("https://oapi.dingtalk.com/gettoken?corpid={0}&corpsecret={1}", Platform.JHMobile.Models.Corp.corp_id, Platform.JHMobile.Models.Corp.corp_secret);
    var request = HttpWebRequest.CreateHttp(url_get_access_token);
    var response = (HttpWebResponse)request.GetResponse();
    var stream = response.GetResponseStream();
    var encoding = System.Text.Encoding.UTF8;
    var reader = new StreamReader(stream, encoding);
    var read = new char[256];
    int count = reader.Read(read, 0, 256);
    var builder = new System.Text.StringBuilder();
    while (count > 0)
    {
        var str = new string(read, 0, count);
        builder.Append(str);
        count = reader.Read(read, 0, 256);
    }
    reader.Close();
    response.Close();
    var access_token = Newtonsoft.Json.JsonConvert.DeserializeObject<dynamic>(builder.ToString()).access_token;
    var url_get_user_info = string.Format("https://oapi.dingtalk.com/user/getuserinfo?access_token={0}&code={1}", access_token, Request.QueryString["code"]);
    request = HttpWebRequest.CreateHttp(url_get_user_info);
    response = (HttpWebResponse)request.GetResponse();
    stream = response.GetResponseStream();
    reader = new StreamReader(stream, encoding);
    read = new char[256];
    count = reader.Read(read, 0, 256);
    builder = new System.Text.StringBuilder();
    while (count > 0)
    {
        var str = new string(read, 0, count);
        builder.Append(str);
        count = reader.Read(read, 0, 256);
    }
    reader.Close();
    response.Close();
    var user_id = Newtonsoft.Json.JsonConvert.DeserializeObject<dynamic>(builder.ToString()).userid;
    var map = new Dictionary<string, string>();
    map.Add("022122292191", "882888");
    if (map.ContainsKey(user_id.ToString()))
    {
        user_id = map[user_id.ToString()];
    }
    Session["user_id"] = user_id;
    Response.Redirect("~/Home/Home");
}
